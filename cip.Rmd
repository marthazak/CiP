---
title: "Workshop microbiome analysis"
author: "ASP2025"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1) Load Libraries
```{r}
library(phyloseq)
library(tidyverse)
library(ggpubr)
library(patchwork)
library(plotly)
library(RColorBrewer)
```

# 2) Create Output Folders
```{r}
dir.create("plots", showWarnings = FALSE)
dir.create("results", showWarnings = FALSE)
```

# 3) Load Data
```{r}
asv <- read.table(
  url("https://raw.githubusercontent.com/marthazak/CiP/main/CiP_count_filtered.tsv"),
  header=TRUE, row.names=1, check.names=FALSE
)

taxonomy <- read.table(
  url("https://raw.githubusercontent.com/marthazak/CiP/main/CiP_taxonomy_filtered.tsv"),
  header=TRUE, sep="\t", row.names=1, fill=TRUE, check.names=FALSE
)

metadata <- read.csv(
  url("https://raw.githubusercontent.com/marthazak/CiP/main/metadata.csv"),
  row.names=1, check.names=FALSE
)

# Match order
metadata <- metadata[match(colnames(asv), rownames(metadata)), ]

physeq <- phyloseq(
  otu_table(as.matrix(asv), taxa_are_rows=TRUE),
  tax_table(as.matrix(taxonomy)),
  sample_data(metadata)
)

physeq <- subset_samples(physeq, Infection %in% c("control","SyDn"))
```

# 4) Filtering & Normalisation
```{r}
# Relative abundance
relAb <- transform_sample_counts(physeq, function(x) x/sum(x))

# Filter taxa > 0.001%
meanThreshold <- 1e-5
relAbFilt <- filter_taxa(relAb, function(x) mean(x) > meanThreshold, TRUE)

physeqFilt <- prune_taxa(taxa_names(relAbFilt), physeq)

# Rarefy
minSample <- min(sample_sums(physeqFilt))
physeqRare <- rarefy_even_depth(physeqFilt, sample.size=minSample, rngseed=123)

# sqrt transform for stats
relAbSqrt <- transform_sample_counts(relAbFilt, sqrt)
```

# 5) Phylum Pie Chart
```{r}
phylum <- tax_glom(physeqFilt, "phylum")

df_phylum <- psmelt(phylum) %>%
  group_by(phylum) %>%
  summarise(total = sum(Abundance)) %>%
  mutate(percent = 100 * total / sum(total))

p_pie <- ggplot(df_phylum, aes(x=1, y=percent, fill=phylum)) +
  geom_col(color="white") +
  coord_polar(theta="y") +
  theme_void() +
  labs(title="Phylum Composition")

p_pie
```

# 6) Bubble Plot of Top 15 Genera
```{r}
genus <- tax_glom(relAbFilt, "genus")
df_genus <- psmelt(genus)

top15 <- df_genus %>%
  group_by(genus) %>%
  summarise(mean_abund = mean(Abundance)) %>%
  slice_max(mean_abund, n=15) %>%
  pull(genus)

df_top <- df_genus %>% filter(genus %in% top15)
df_top
if(!"label" %in% colnames(df_top))
  df_top$label <- df_top$Sample

p_bubble <- ggplot(df_top, aes(x=label, y=genus, size=Abundance, fill=genus)) +
  geom_point(shape=21, alpha=0.9) +
  scale_size(range=c(2,18)) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
        legend.position="none") +
  labs(title="Top 15 Genera — Bubble Plot", x="Sample", y="Genus")

p_bubble
```

# 7) Stacked Barplot
```{r}
df_bar <- df_top %>% group_by(label, genus) %>% summarise(Abundance=sum(Abundance))

p_bar <- ggplot(df_bar, aes(x=label, y=Abundance, fill=genus)) +
  geom_col(color="white") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title="Genus Composition", x="Sample", y="Relative Abundance")

p_bar
```

# 8) Heatmap
```{r}
df_heat <- df_bar

p_heat <- ggplot(df_heat, aes(x=label, y=genus, fill=Abundance)) +
  geom_tile(color="white") +
  scale_fill_gradient(low="white", high="steelblue") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(title="Genus Heatmap")

p_heat
```

# 9) Boxplot (Example: Staphylococcus)
```{r}
df_staph <- df_genus %>% filter(str_detect(genus, "Staphylococcus"))

if(nrow(df_staph) > 0){
  df_staph$group <- paste(df_staph$Infection, df_staph$Timepoint, sep="_")

  p_box <- ggplot(df_staph, aes(x=group, y=Abundance, fill=Infection)) +
    geom_boxplot() +
    theme(axis.text.x=element_text(angle=90)) +
    labs(title="Staphylococcus Relative Abundance")

  p_box
}
```

# 10) Alpha Diversity
```{r}
alpha_metrics <- estimate_richness(physeqRare, measures=c("Observed","Shannon"))
df_alpha <- bind_cols(alpha_metrics, sample_data(physeqRare)$Group1, sample_data(physeqRare)$Infection)
colnames(df_alpha)<- c("Observed", "Shannon", "Group1", "Infection")
p_alpha <- ggplot(df_alpha, aes(x=Group1, y=Shannon, color=Infection)) +
  geom_boxplot() +
  labs(title="Alpha Diversity (Shannon)")

p_alpha
```

# 11) Beta Diversity – Bray Curtis Dendrogram
```{r}
bc_dist <- phyloseq::distance(physeqRare, method="bray")
dist_mat <- as.matrix(bc_dist)
rownames(dist_mat) <- sample_data(physeqRare)$Group1

hc <- hclust(as.dist(dist_mat), method="average")
plot(hc, main="Bray–Curtis Dendrogram")
```

# 12) PCoA — 2D & 3D
## 12.1 PCoA 2D (ggplot)
```{r}
pcoa_res <- ordinate(physeqRare, method="PCoA", distance="bray")

p_pcoa2D <- plot_ordination(physeqRare, pcoa_res, type="samples") +
  geom_point(aes(color=Infection, shape=Timepoint), size=4) +
  theme_minimal() +
  labs(title="PCoA (2D)")

p_pcoa2D
```

## 12.2 PCoA 3D (plotly)
```{r}
coords <- as.data.frame(pcoa_res$vectors[,1:3])
coords$Sample <- rownames(coords)
coords <- cbind(coords, metadata[coords$Sample, ])

coords$TP_Inf <- paste(coords$Timepoint, coords$Infection, sep="_")

p_pcoa3D <- plot_ly(
  coords,
  x = ~Axis.1, y = ~Axis.2, z = ~Axis.3,
  color = ~TP_Inf,
  symbol = ~TP_Inf,
  text = ~Sample,
  type = "scatter3d",
  mode = "markers",
  marker = list(size = 5)
)

p_pcoa3D
```

# 13) Paired t–Tests (TP-1 vs TP-2)
```{r}
genera <- unique(df_genus$genus)
results <- tibble(taxon=character(), pvalue=numeric(), fdr=numeric())

for(g in genera){
  dsub <- df_genus %>% filter(genus==g)

  if(!all(c("TP-1","TP-2") %in% unique(dsub$Timepoint))) next

  d1 <- dsub %>% filter(Timepoint=="TP-1") %>% select(Pair, Abundance)
  d2 <- dsub %>% filter(Timepoint=="TP-2") %>% select(Pair, Abundance)

  merged <- merge(d1, d2, by="Pair", suffixes=c(".x",".y"))
  if(nrow(merged) < 3) next

  t_res <- try(t.test(merged$Abundance.x, merged$Abundance.y, paired=TRUE), silent=TRUE)

  if(inherits(t_res, "htest")){
    results <- add_row(results, taxon=g, pvalue=t_res$p.value, fdr=NA_real_)
  }
}

if(nrow(results)>0){
  results$fdr <- p.adjust(results$pvalue, method="fdr")
  write_csv(results, "results/paired_ttests.csv")
}

results
```

---

# Analysis Complete
All plots saved in **plots/** and all statistics saved in **results/**.

